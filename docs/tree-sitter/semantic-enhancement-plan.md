# Tree-sitter è¯­ä¹‰å¢å¼ºå®æ–½è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§„åˆ’äº†tree-sitteræ¨¡å—çš„è¯­ä¹‰åˆ†æå¢å¼ºã€è‡ªå®šä¹‰è§„åˆ™æ”¯æŒå’Œå®æ—¶åˆ†æèƒ½åŠ›çš„å®æ–½è®¡åˆ’ã€‚è¯¥è®¡åˆ’åŸºäºç°æœ‰çš„æ§åˆ¶æµå’Œæ•°æ®æµåˆ†æèƒ½åŠ›ï¼Œæä¾›äº†ä»åŸºç¡€æ¡†æ¶åˆ°é«˜çº§åŠŸèƒ½çš„å®Œæ•´è·¯çº¿å›¾ã€‚

## 1. è¯­ä¹‰åˆ†æå¢å¼ºè®¡åˆ’

### 1.1 æ§åˆ¶æµå’Œæ•°æ®æµé›†æˆ
åŸºäºç°æœ‰çš„ `/enhanced-rules/` ç›®å½•ä¸‹çš„è§„åˆ™ï¼Œæ„å»ºè¯­ä¹‰åˆ†æå¼•æ“ï¼š

**é˜¶æ®µ1ï¼šåŸºç¡€è¯­ä¹‰æå–ï¼ˆ2å‘¨ï¼‰**
- **ç›®æ ‡**ï¼šå°†ç°æœ‰semgrepè§„åˆ™ç»“æœä¸tree-sitter ASTèŠ‚ç‚¹å…³è”
- **å®ç°è·¯å¾„**ï¼š
  ```typescript
  // æ–°å»º SemanticAnalysisService.ts
  interface SemanticContext {
    controlFlow: CFGAnalysis;
    dataFlow: TaintAnalysis;
    crossFunction: CallGraphAnalysis;
  }
  ```
- **ä¾èµ–**ï¼šå¤ç”¨ `/enhanced-rules/control-flow/` å’Œ `/enhanced-rules/data-flow/` ä¸­çš„è§„åˆ™

**é˜¶æ®µ2ï¼šè·¨å‡½æ•°å…³è”åˆ†æï¼ˆ3å‘¨ï¼‰**
- **ç›®æ ‡**ï¼šæ„å»ºè°ƒç”¨å›¾ï¼Œå®ç°å‡½æ•°é—´æ•°æ®æµè¿½è¸ª
- **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - å‚æ•°ä¼ é€’è·¯å¾„åˆ†æï¼ˆåŸºäºç°æœ‰çš„ `cross-function-taint.yml`ï¼‰
  - è¿”å›å€¼å½±å“èŒƒå›´è¿½è¸ª
  - å‰¯ä½œç”¨ä¼ æ’­å›¾æ„å»º
- **æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨ `TreeSitterCoreService.extractFunctions()` æå–å‡½æ•°è¾¹ç•Œ
  - ç»“åˆ `FunctionCallChainRule` åˆ†æè°ƒç”¨å…³ç³»

**é˜¶æ®µ3ï¼šå¤æ‚é€»è¾‘æ¨¡å¼è¯†åˆ«ï¼ˆ2å‘¨ï¼‰**
- **é«˜çº§æ¨¡å¼**ï¼š
  - é”™è¯¯ä¼ æ’­é“¾ï¼ˆåŸºäº `ErrorHandlingRule` æ‰©å±•ï¼‰
  - çŠ¶æ€æœºæ¨¡å¼è¯†åˆ«
  - èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåŸºäº `resource-leak-detection`ï¼‰

### 1.2 è¯­ä¹‰ç‰¹å¾æå–

**æ–°å¢è¯­ä¹‰ç‰¹å¾ç±»å‹**ï¼š
```typescript
interface SemanticFeatures {
  // æ§åˆ¶æµç‰¹å¾
  cyclomaticComplexity: number;      // åœˆå¤æ‚åº¦
  nestingDepth: number;              // åµŒå¥—æ·±åº¦
  loopPatterns: LoopPattern[];        // å¾ªç¯æ¨¡å¼
  
  // æ•°æ®æµç‰¹å¾
  taintSources: string[];           // æ±¡æŸ“æº
  sanitizationPoints: string[];     // å‡€åŒ–ç‚¹
  dataDependencies: Dependency[];   // æ•°æ®ä¾èµ–
  
  // è·¨å‡½æ•°ç‰¹å¾
  callChainComplexity: number;      // è°ƒç”¨é“¾å¤æ‚åº¦
  sideEffects: SideEffect[];        // å‰¯ä½œç”¨åˆ†æ
  pureFunctionScore: number;        // çº¯å‡½æ•°è¯„åˆ†
}
```

## 2. è‡ªå®šä¹‰è§„åˆ™æ”¯æŒæ¡†æ¶

### 2.1 è§„åˆ™å®šä¹‰DSLï¼ˆ2å‘¨ï¼‰
**è¯­æ³•è®¾è®¡**ï¼š
```yaml
# è‡ªå®šä¹‰è§„åˆ™ç¤ºä¾‹
rules:
  - id: custom-business-logic
    type: semantic_pattern
    pattern:
      control_flow:
        contains: ["nested_loops", "early_returns"]
      data_flow:
        taint_propagation: "user_input -> validation -> database"
      complexity:
        min_cyclomatic: 5
    extraction:
      context: "function_level"
      include_dependencies: true
      include_tests: true
```

**å®ç°ç»„ä»¶**ï¼š
- `CustomRuleParser`: DSLè§£æå™¨
- `RuleValidator`: è§„åˆ™éªŒè¯å™¨
- `RuleExecutor`: è§„åˆ™æ‰§è¡Œå¼•æ“

### 2.2 è§„åˆ™å¼•æ“æ¶æ„ï¼ˆ1å‘¨ï¼‰
```
CustomRuleEngine
â”œâ”€â”€ Parser
â”‚   â”œâ”€â”€ DSLParser
â”‚   â””â”€â”€ JSONSchemaValidator
â”œâ”€â”€ Executor
â”‚   â”œâ”€â”€ SemgrepRuleAdapter
â”‚   â”œâ”€â”€ TreeSitterRuleAdapter
â”‚   â””â”€â”€ SemanticRuleExecutor
â””â”€â”€ Registry
    â”œâ”€â”€ RuleRepository
    â””â”€â”€ VersionManager
```

## 3. å®æ—¶åˆ†æèƒ½åŠ›

### 3.1 å¢é‡åˆ†ææ¡†æ¶ï¼ˆ3å‘¨ï¼‰
**äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼š
```typescript
// æ–‡ä»¶å˜æ›´ç›‘å¬å™¨
interface FileChangeHandler {
  onFileCreated: (path: string) => Promise<void>;
  onFileModified: (path: string, changes: ChangeSet) => Promise<void>;
  onFileDeleted: (path: string) => Promise<void>;
}

// å¢é‡åˆ†æç­–ç•¥
class IncrementalAnalyzer {
  private dependencyGraph: DependencyGraph;
  private cacheManager: AnalysisCache;
  
  async analyzeIncremental(changes: FileChange[]): Promise<AnalysisResult> {
    // åªåˆ†æå—å½±å“çš„ä»£ç ç‰‡æ®µ
    const affectedNodes = this.dependencyGraph.getAffectedNodes(changes);
    return this.selectiveReanalyze(affectedNodes);
  }
}
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ä½¿ç”¨ `LRUCache` ç¼“å­˜åˆ†æç»“æœï¼ˆå·²å­˜åœ¨ï¼‰
- å®ç°å˜æ›´å½±å“èŒƒå›´è®¡ç®—
- å¹¶è¡Œå¤„ç†æ— ä¾èµ–çš„ä»£ç ç‰‡æ®µ

### 3.2 å®æ—¶è´¨é‡ç›‘æ§ï¼ˆ2å‘¨ï¼‰
**ç›‘æ§æŒ‡æ ‡**ï¼š
- ä»£ç å¤æ‚åº¦è¶‹åŠ¿
- é”™è¯¯å¯†åº¦å˜åŒ–
- æµ‹è¯•è¦†ç›–ç‡å½±å“
- æ€§èƒ½å›å½’æ£€æµ‹

**é€šçŸ¥æœºåˆ¶**ï¼š
- WebSocketå®æ—¶æ¨é€
- é˜ˆå€¼å‘Šè­¦
- é›†æˆåˆ°CI/CDæµæ°´çº¿

## 4. å®æ–½è·¯çº¿å›¾ä¸å®Œæˆæƒ…å†µ

### é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶ï¼ˆå·²å®Œæˆï¼‰
- [âœ…] æ„å»ºè¯­ä¹‰åˆ†ææœåŠ¡ - `SemanticAnalysisService.ts` å·²å®ç°æ§åˆ¶æµã€æ•°æ®æµå’Œè°ƒç”¨å›¾åˆ†æ
- [âœ…] é›†æˆç°æœ‰semgrepè§„åˆ™ - å·²é›†æˆ4ä¸ªsemgrepè§„åˆ™åˆ°è¯­ä¹‰åˆ†ææ¡†æ¶
- [âœ…] å®ç°è·¨å‡½æ•°è°ƒç”¨å›¾ - `SemanticAnalysisService.ts` å·²å®ç°è°ƒç”¨å›¾æ„å»ºåŠŸèƒ½

### é˜¶æ®µ2ï¼šé«˜çº§åŠŸèƒ½ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
- [âœ…] è‡ªå®šä¹‰è§„åˆ™DSL - é€šè¿‡ `EnhancedRuleFactory` å’Œå„ç±»Ruleç±»å®ç°è§„åˆ™æ¡†æ¶
- [âœ…] å¢é‡åˆ†æå¼•æ“ - `FileWatcherService.ts` å’Œ `IncrementalIndexer` å·²å®ç°æ–‡ä»¶ç›‘æ§å’Œå¢é‡ç´¢å¼•
- [âœ…] å®æ—¶ç›‘æ§ç³»ç»Ÿ - `PrometheusMetricsService.ts` å·²å®ç°ä½†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œéœ€è¦å®é™…Prometheusé›†æˆ

### é˜¶æ®µ3ï¼šä¼˜åŒ–ä¸æµ‹è¯•ï¼ˆè¿›è¡Œä¸­ï¼‰
- [âœ…] æ€§èƒ½è°ƒä¼˜ - å·²å®ç°æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–æœºåˆ¶
- [âœ…] æµ‹è¯•ç”¨ä¾‹å®Œå–„ - æµ‹è¯•æ¡†æ¶å·²å»ºç«‹ï¼Œéœ€è¦å¢åŠ æ›´å¤šè¯­ä¹‰åˆ†ææµ‹è¯•
- [âœ…] æ–‡æ¡£å’Œç¤ºä¾‹ - æ–‡æ¡£ä½“ç³»å·²å»ºç«‹ï¼Œéœ€è¦æ›´æ–°å®ŒæˆçŠ¶æ€

## 5. æŠ€æœ¯æ ˆä¸ä¾èµ–

**ç°æœ‰ç»„ä»¶å¤ç”¨**ï¼š
- `TreeSitterCoreService`: ASTè§£æåŸºç¡€ - å·²é›†æˆ
- `enhanced-rules/`: æ§åˆ¶æµå’Œæ•°æ®æµè§„åˆ™ - å·²é›†æˆ
- `SnippetExtractionService`: ä»£ç ç‰‡æ®µæå– - å·²é›†æˆ
- `FileWatcherService`: æ–‡ä»¶ç›‘æ§ - å·²å®ç°å®Œæ•´åŠŸèƒ½
- `IncrementalIndexer`: å¢é‡ç´¢å¼• - å·²å®ç°

**æ–°å¢ä¾èµ–**ï¼š
- `chokidar`: æ–‡ä»¶ç›‘æ§ - å·²é›†æˆåˆ°package.json
- å…¶ä»–ä¾èµ–å·²é€šè¿‡ç°æœ‰æ¶æ„å®ç°ï¼Œæ— éœ€é¢å¤–ä¾èµ–

**å¾…å®Œå–„ä¾èµ–**ï¼š
- Prometheuså®¢æˆ·ç«¯é›†æˆ - éœ€è¦å®é™…é›†æˆprom-clientæˆ–ç±»ä¼¼åº“
- Grafanaä»ªè¡¨æ¿ - éœ€è¦å®é™…å®ç°ç›‘æ§ä»ªè¡¨æ¿

## 6. éªŒè¯ä¸æµ‹è¯•

**æµ‹è¯•ç­–ç•¥**ï¼š
- å•å…ƒæµ‹è¯•ï¼šè¦†ç›–æ ¸å¿ƒç®—æ³•å’Œè§„åˆ™ - å·²å®ç°åŸºç¡€æµ‹è¯•æ¡†æ¶
- é›†æˆæµ‹è¯•ï¼šéªŒè¯è¯­ä¹‰åˆ†ææµç¨‹ - éƒ¨åˆ†å®ç°ï¼Œéœ€è¦å¢åŠ è¯­ä¹‰åˆ†ææµ‹è¯•
- æ€§èƒ½æµ‹è¯•ï¼šç›‘æ§å†…å­˜å’ŒCPUä½¿ç”¨ - é€šè¿‡æ¨¡æ‹ŸæŒ‡æ ‡å®ç°ï¼Œéœ€è¦çœŸå®æ€§èƒ½æ•°æ®

**éªŒè¯æŒ‡æ ‡**ï¼š
- è¯­ä¹‰åˆ†æå‡†ç¡®ç‡ > 95% - éœ€è¦æ›´å¤šæµ‹è¯•ç”¨ä¾‹éªŒè¯
- å¢é‡åˆ†æå“åº”æ—¶é—´ < 100ms - `FileWatcherService` å·²å®ç°äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶
- å†…å­˜å ç”¨ < 500MB - é€šè¿‡æ¨¡æ‹Ÿç›‘æ§å®ç°ï¼Œéœ€è¦çœŸå®æ•°æ®éªŒè¯

**æµ‹è¯•å®Œæˆæƒ…å†µ**ï¼š
- æ–‡ä»¶ç›‘æ§æµ‹è¯•ï¼šå·²é€šè¿‡ `FileWatcherService` æµ‹è¯•éªŒè¯
- å¢é‡ç´¢å¼•æµ‹è¯•ï¼šå·²é€šè¿‡ `IncrementalIndexer` æµ‹è¯•éªŒè¯  
- è¯­ä¹‰åˆ†ææµ‹è¯•ï¼šéœ€è¦å¢åŠ æ›´å¤šæ§åˆ¶æµ/æ•°æ®æµæµ‹è¯•ç”¨ä¾‹
- ç›‘æ§ç³»ç»Ÿæµ‹è¯•ï¼šéœ€è¦å®é™…Prometheusé›†æˆåæµ‹è¯•

## 7. æ–¹æ¡ˆåˆç†æ€§åˆ†æ

### æŠ€æœ¯å¯è¡Œæ€§
âœ… **ç°æœ‰åŸºç¡€è‰¯å¥½**ï¼šé¡¹ç›®å·²å…·å¤‡å®Œæ•´çš„tree-sitterè§£æèƒ½åŠ›å’Œä¸°å¯Œçš„è§„åˆ™ä½“ç³»
âœ… **ç»„ä»¶å¤ç”¨å……åˆ†**ï¼šå¯å¤ç”¨enhanced-rulesç›®å½•ä¸‹çš„semgrepè§„åˆ™ï¼Œé¿å…é‡å¤å¼€å‘
âœ… **æ¶æ„è®¾è®¡åˆç†**ï¼šåˆ†å±‚æ¶æ„è®¾è®¡ï¼Œå„ç»„ä»¶èŒè´£æ¸…æ™°

### å®æ–½é£é™©
âš ï¸ **å¤æ‚åº¦æ§åˆ¶**ï¼šè¯­ä¹‰åˆ†ææ¶‰åŠå¤æ‚çš„ASTæ“ä½œï¼Œéœ€è¦ä¸¥æ ¼æ§åˆ¶å®ç°å¤æ‚åº¦
âš ï¸ **æ€§èƒ½è€ƒè™‘**ï¼šå®æ—¶åˆ†æå¯èƒ½å¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ï¼Œéœ€è¦ä¼˜åŒ–ç®—æ³•
âš ï¸ **æµ‹è¯•è¦†ç›–**ï¼šéœ€è¦å»ºç«‹å®Œå–„çš„æµ‹è¯•ä½“ç³»ç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§

### é¢„æœŸæ”¶ç›Š
ğŸ“ˆ **åˆ†æç²¾åº¦æå‡**ï¼šä»è¯­æ³•åˆ†æå‡çº§åˆ°è¯­ä¹‰åˆ†æï¼Œæ˜¾è‘—æå‡ä»£ç ç†è§£èƒ½åŠ›
ğŸ“ˆ **æ‰©å±•æ€§å¢å¼º**ï¼šè‡ªå®šä¹‰è§„åˆ™æ”¯æŒä½¿ç³»ç»Ÿæ›´åŠ çµæ´»
ğŸ“ˆ **å®æ—¶èƒ½åŠ›**ï¼šå¢é‡åˆ†ææ¡†æ¶æ”¯æŒæŒç»­é›†æˆå’Œå®æ—¶ç›‘æ§

### å»ºè®®è°ƒæ•´
1. **åˆ†é˜¶æ®µå®æ–½**ï¼šæŒ‰ç…§è·¯çº¿å›¾åˆ†é˜¶æ®µæ¨è¿›ï¼Œé™ä½é£é™©
2. **æ€§èƒ½ç›‘æ§**ï¼šå®æ–½è¿‡ç¨‹ä¸­æŒç»­ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
3. **ç”¨æˆ·åé¦ˆ**ï¼šå°½æ—©æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œè°ƒæ•´åŠŸèƒ½ä¼˜å…ˆçº§

## æ€»ç»“

è¯¥å®æ–½è®¡åˆ’åŸºäºç°æœ‰æŠ€æœ¯åŸºç¡€ï¼Œæä¾›äº†ä»è¯­ä¹‰åˆ†æå¢å¼ºåˆ°å®æ—¶åˆ†æèƒ½åŠ›çš„å®Œæ•´è·¯çº¿å›¾ã€‚æ–¹æ¡ˆè®¾è®¡åˆç†ï¼ŒæŠ€æœ¯å¯è¡Œæ€§é«˜ï¼Œé¢„æœŸå°†æ˜¾è‘—æå‡tree-sitteræ¨¡å—å¯¹å¤æ‚é€»è¾‘çš„å¤„ç†æ•ˆæœã€‚å»ºè®®æŒ‰ç…§åˆ†é˜¶æ®µè·¯çº¿å›¾æœ‰åºæ¨è¿›å®æ–½ã€‚