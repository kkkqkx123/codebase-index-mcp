### 7. **安全删除目录操作指南**

当需要完全删除该目录结构时，建议按照以下步骤进行安全操作：

#### **步骤1：停止所有相关容器**

```bash
# 在share目录下执行
cd /home/docker-compose/codebase-index/share

# 停止所有正在运行的容器
docker-compose -f monitoring/docker-compose.monitoring.yml down
docker-compose -f nebula/docker-compose.nebula.yml down
docker-compose -f qdrant/docker-compose.qdrant.yml down

# 强制停止所有相关容器（如有必要）
docker ps -a --filter name=monitoring -q | xargs docker stop
docker ps -a --filter name=nebula -q | xargs docker stop
docker ps -a --filter name=qdrant -q | xargs docker stop
```

#### **步骤2：清理数据卷和容器**

```bash
# 删除相关容器
docker ps -a --filter name=monitoring -q | xargs docker rm
docker ps -a --filter name=nebula -q | xargs docker rm
docker ps -a --filter name=qdrant -q | xargs docker rm

# 清理未使用的镜像（可选）
docker image prune -f
```

#### **步骤3：验证无进程占用**

```bash
# 检查端口占用情况
netstat -tulpn | grep -E "(9090|3000|9669|6333)"

# 检查挂载点
mount | grep /home/docker-compose/codebase-index/share
```

#### **步骤4：安全删除目录**

```bash
# 回到上级目录
cd /home/docker-compose/codebase-index/

# 使用rsync进行安全删除（推荐，可显示进度）
rsync -a --delete --progress /tmp/empty_dir/ share/

# 或者使用rm命令（谨慎使用）
rm -rf share/

# 或者使用find命令（更安全的逐步删除）
find share/ -type f -delete
find share/ -type d -delete
```

#### **步骤5：清理系统残留**

```bash
# 清理Docker网络（如果创建了自定义网络）
docker network ls | grep monitoring && docker network rm monitoring

# 清理Docker卷（如有需要）
docker volume ls | grep -E "(monitoring|nebula|qdrant)" | awk '{print $2}' | xargs docker volume rm
```

#### **一键删除脚本**

为了方便操作，可以创建一个删除脚本：

```bash
#!/bin/bash
# cleanup-share.sh - 安全删除share目录

set -e

echo "=== 开始清理share目录 ==="

# 1. 停止容器
echo "正在停止相关容器..."
docker-compose -f monitoring/docker-compose.monitoring.yml down 2>/dev/null || true
docker-compose -f nebula/docker-compose.nebula.yml down 2>/dev/null || true
docker-compose -f qdrant/docker-compose.qdrant.yml down 2>/dev/null || true

# 2. 删除容器
echo "正在删除容器..."
docker ps -a --filter name=monitoring -q | xargs docker rm -f 2>/dev/null || true
docker ps -a --filter name=nebula -q | xargs docker rm -f 2>/dev/null || true
docker ps -a --filter name=qdrant -q | xargs docker rm -f 2>/dev/null || true

# 3. 删除目录
echo "正在删除目录..."
cd /home/docker-compose/codebase-index/
if [ -d "share" ]; then
    rm -rf share/
    echo "✓ share目录已安全删除"
else
    echo "✓ share目录不存在"
fi

# 4. 清理网络
echo "正在清理网络..."
docker network rm monitoring 2>/dev/null || true

echo "=== 清理完成 ==="
```

#### **权限恢复说明**

删除后如需重新部署，请确保：

1. **重新创建目录**:
   ```bash
   mkdir -p /home/docker-compose/codebase-index/share
   chmod 755 /home/docker-compose/codebase-index/share
   ```

2. **重新运行配置脚本**:
   ```bash
   cd /home/docker-compose/codebase-index/share
   # 重新复制配置文件并运行setup-config-files.sh
   ```

#### **注意事项**

- ⚠️ **数据备份**: 删除前请确保重要数据已备份
- ⚠️ **权限验证**: 删除前确认当前用户有足够权限
- ⚠️ **容器状态**: 确保所有相关容器已完全停止
- ⚠️ **网络依赖**: 检查是否有其他服务依赖这些容器

通过以上步骤，可以安全、彻底地删除整个目录结构，避免残留文件或权限问题。