# 项目隔离机制分析

## 概述

当前系统在设计上考虑了多项目支持，但在实际实现中存在一些隔离不足的问题。本分析文档旨在深入理解当前的项目隔离机制，并识别存在的问题和改进空间。

## 当前项目隔离机制

### 1. 项目标识
系统通过 `HashUtils.calculateDirectoryHash()` 方法为每个项目生成唯一的项目ID：
```typescript
const projectId = await HashUtils.calculateDirectoryHash(projectPath);
```

这个项目ID在多个地方被使用：
- 作为向量点的 `projectId` 字段
- 作为搜索过滤条件
- 作为删除操作的标识

### 2. 数据库层面的隔离

#### Qdrant 向量数据库
在 `VectorStorageService` 中，系统使用固定的集合名称（从配置中读取）：
```typescript
this.config = {
  collectionName: qdrantConfig.collection, // 默认为 'code-snippets'
  // ...
};
```

虽然在向量点的 payload 中包含了 `projectId` 字段，但所有项目共享同一个集合，通过 `projectId` 进行逻辑隔离。

#### Nebula Graph 图数据库
同样，所有项目共享同一个图空间（space），通过项目ID进行逻辑隔离。

### 3. 当前隔离机制的问题

1. **资源共享**：所有项目共享同一个数据库集合/空间，可能导致资源竞争
2. **性能影响**：大项目可能影响其他项目的查询性能
3. **安全性不足**：缺乏物理隔离，存在数据泄露风险
4. **管理困难**：难以单独管理、备份或删除特定项目的数据
5. **配置僵化**：所有项目使用相同的数据库配置

## 现有实现的优势

1. **简单性**：实现相对简单，易于理解和维护
2. **资源共享**：充分利用数据库资源，避免资源浪费
3. **统一管理**：便于统一监控和管理所有项目

## 隔离机制的局限性

### 1. 物理隔离缺失
当前实现仅通过 `projectId` 字段进行逻辑隔离，缺乏物理隔离：
- 所有项目数据存储在同一个 Qdrant 集合中
- 所有项目数据存储在同一个 Nebula Graph 空间中

### 2. 查询性能问题
随着项目数量增加，单一集合/空间中的数据量会急剧增长，可能影响查询性能：
- 索引效率下降
- 查询响应时间增加
- 内存使用量增加

### 3. 安全性考虑
逻辑隔离在安全性方面存在不足：
- 项目间数据可能被意外访问
- 缺乏项目级别的访问控制
- 数据泄露风险增加

### 4. 管理和维护困难
- 难以单独备份或恢复特定项目的数据
- 难以针对特定项目进行性能调优
- 难以单独删除或迁移项目数据

## 改进建议

根据 `docs/plan/multi-project.md` 中的计划，需要修改 Qdrant 和 Nebula 模块，检测项目路径名称，为每个项目创建独立的代码库索引。

这表明当前实现确实存在隔离不足的问题，需要通过物理隔离来解决。